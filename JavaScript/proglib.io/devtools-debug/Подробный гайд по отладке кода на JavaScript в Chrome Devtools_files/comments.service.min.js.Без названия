!function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(o,r,function(t){return e[t]}.bind(null,r));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="https://static.proglib.io",n(n.s=346)}({0:function(e,t){function n(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}e.exports=function(e,t,o){return t&&n(e.prototype,t),o&&n(e,o),e}},115:function(e,t,n){},14:function(e,t,n){"use strict";n.d(t,"a",(function(){return o})),n.d(t,"c",(function(){return r})),n.d(t,"b",(function(){return i}));var o={image:"image/*",resume:"application/msword,application/pdf"},r=function(e){return new Promise((function(t){var n=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=document.createElement("input");return t.type="file",t.multiple=e.multiple,t.accept=e.accept,t.className="visually-hidden",t}(e);return document.body.appendChild(n),n.onchange=function(e){var o=event.target.files;t({files:o,input:n})},n.click(),n}))},i=function(e){return new Promise((function(t,n){var o=new FileReader;o.readAsDataURL(e),o.onload=function(e){t(e.target.result)}}))}},2:function(e,t){e.exports=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}},20:function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var o=function(e){return 0==e.indexOf("http")?e:0==e.indexOf("data:image")?e:window.mediaDomainUrl+"/"+e}},23:function(e,t,n){"use strict";function o(e,t){return t[e%100>4&&e%100<20?2:[2,0,1,1,1,2][e%10<5?e%10:5]]}o.TAGS={dat:["тег","тега","тегов"],gen:["тег","тега","тегов"]},o.SYMBOLS={dat:["символ","символа","символов"],gen:["символа","символов","символов"]},o.WORDS={dat:["слово","слова","слов"],gen:["слова","слов","слов"]},o.MINUTES={dat:["минуту","минуты","минут"]},o.HOURS={dat:["час","часа","часов"]},o.KEYS=["one","few","more"],t.a=o},3:function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var o={403:"Запрещено",413:"Request Entity Too Large"},r=function(e,t){return new Promise((function(n,r){fetch(e,t).then((function(e){if(e.ok)return e;throw 401==e.status?(window.showAuthPopup(),new Error("not-auth")):new Error(e.status)})).then((function(e){n(e.json())})).catch((function(e){var t=o[e.message]||"Что-то пошло не так";r(t)}))}))}},346:function(e,t,n){"use strict";n.r(t);n(115);var o,r,i,a=n(3),c=n(23),u=function(e){return Array.from(e.children).filter((function(e){return e.classList.contains("comment")}))},s=n(4),l="data-fold",d="data-loading",m=function(e){e.more&&e.more.setAttribute(d,""),e.children.forEach((function(e){f(e.element)})),e.childrenList.removeAttribute(l)},f=function(e,t){var n=function e(t,n){var o=t.querySelector(".comment-entity"),r=o?o.querySelector('[data-reaction="like"]'):null,i=r?r.querySelector("[data-reaction-count]"):null,a={element:t,likesCount:i,created:t.dataset.created,children:[]};if(i&&(t.style.order=-1*(parseInt(i.textContent)||0)-1),!t)return a;if(!n)return a;n-=1;var c,s,l=t.querySelector(".comment__children");if(!l)return a;a.childrenList=l,a.more=(s=(c=l).dataset.commentId,c.querySelector('[data-more="'.concat(s,'"]')));var d=u(l);return a.children=d.map((function(t){return e(t,n)})),a.childrenCount=a.children.reduce((function(e,t){return e+(t.childrenCount||0)+1}),0),a}(e,4);if(n.childrenCount>2){var o=n.children.reduce((function(e,t){return t.childrenCount>2?e+1:e+t.childrenCount+1}),0);t?m(n):function(e,t){e.childrenList.setAttribute("data-fold",""),function(e){return e.sort((function(e,t){return t.created-e.created})),e[0]}(e.children).element.classList.add("recent"),e.more.textContent=t+" "+Object(c.a)(t,["ответ","ответа","ответов"]),e.more.addEventListener("click",(function(t){m(e)}))}(n,o)}},h=function(){var e=new URL(window.location.href),t=e.searchParams.get("comment");if(t){var n=o.querySelector('.comment-entity[data-id="'.concat(t,'"]'));if(n){!function(e){for(var t=[],n=e.closest(".comment__children");n;){var o=n.closest(".comment");if(!o)break;n=o.closest(".comment__children"),o&&t.push(o)}t.reverse().forEach((function(e){var t=e.closest(".comment");f(t,"open")}))}(n);var r=e.searchParams.get("action");if("answer"===r||"edit"===r){var i="answer"===r?"[data-comment-reply]":"[data-comment-edit]",a=n.querySelector(i);a&&a.click()}document.querySelector("#comment-".concat(t)).scrollIntoView()}}},v=function(e){return new Promise((function(t,n){var r=(o=e).dataset.action;r||n(),Object(a.a)(r,{method:"POST"}).then((function(e){e.success?(e.html.trim()&&(o.innerHTML=e.html,u(o).forEach((function(e){f(e)})),document.querySelector("[data-comments-filter]").style.display="block"),o.setAttribute("data-loaded",""),o.removeAttribute("data-error"),o.style.display="",Object(s.a)(document.body,"update.lazy"),h(),t()):(o.setAttribute("data-error",""),o.style.display="",n())})).catch((function(e){o.setAttribute("data-error",""),o.style.display="",console.error(e),n()}))}))},p=n(2),y=n.n(p),b=n(0),g=n.n(b),w=n(20),_=function(){function e(t,n){var o=this;y()(this,e),this._form=t,this._replaceFragment=new RegExp(this._form.dataset.replace,"g"),n.onCommentCreate&&"function"==typeof n.onCommentCreate&&(this.onCommentCreate=n.onCommentCreate.bind(this)),this.nodes={comment:this._form.querySelector('[name="commentContent"]'),previewContainer:this._form.querySelector("[data-previews]"),images:[],from:this._form.querySelector('[name="from"]'),previewTmp:this._form.querySelector("[data-preview-tmp]"),submit:this._form.querySelector('[type="submit"]')},this.nodes.comment.addEventListener("keydown",(function(e){window.checkAuth()||e.preventDefault()})),this._actions=this._form.dataset,this._form.onsubmit=function(e){if(e.preventDefault(),!window.checkAuth())return e.preventDefault(),!1;o._onSubmit()}}return g()(e,[{key:"focus",value:function(){this.nodes.comment.focus()}},{key:"setData",value:function(e){var t=this;this.text=e.comment||"",this.from=e.from,e.images.forEach((function(e){t._createImageField(e)}))}},{key:"_createImageField",value:function(e){var t=this,n=document.createElement("input");n.type="hidden",n.name="commentImgUrls[]",n.value=e;var o=this.nodes.previewTmp.cloneNode(!0);o.querySelector("img").src=Object(w.a)(e),o.appendChild(n),this.nodes.previewContainer.appendChild(o);var r={input:n,preview:o};this.nodes.images.push(r),o.querySelector("[data-close]").addEventListener("click",(function(){t._deleteImage(r)}))}},{key:"_deleteImage",value:function(e){e.input.remove(),e.preview.remove();var t=this.nodes.images.indexOf(e);-1!==t&&this.nodes.images.splice(t,1)}},{key:"clear",value:function(){this.text="",this.nodes.images.forEach((function(e){e.preview.remove(),e.input.remove()})),this.nodes.images.length=0,this.nodes.previewContainer.innerHTML=""}},{key:"close",value:function(){this._form.remove()}},{key:"_onSubmit",value:function(){var e=this;this.nodes.submit.setAttribute("data-loading",""),this.nodes.submit.disabled=!0;var t=new FormData(this._form);Object(a.a)(this._form.action,{method:"POST",body:t}).then((function(t){e.nodes.submit.removeAttribute("data-loading"),e.nodes.submit.disabled=!1,e.onCommentCreate&&e.onCommentCreate(t)})).catch((function(t){e.nodes.submit.removeAttribute("data-loading"),e.nodes.submit.disabled=!1,console.error(t)}))}},{key:"urlsCount",get:function(){return this._form.querySelectorAll('[name="commentImgUrls[]"]').length}},{key:"form",get:function(){return this._form}},{key:"state",get:function(){return this._state},set:function(e){this._state=e;var t=this._form.dataset["".concat(e,"State")];this.entity&&(t=t.replace(this._replaceFragment,this.entity.id)),this._form.action=t}},{key:"entity",get:function(){return this._entity},set:function(e){this._entity=e}},{key:"text",get:function(){return this.nodes.comment.value},set:function(e){this.nodes.comment.value=e}},{key:"from",set:function(e){this.nodes.from.checked=!!e}}]),e}(),k=function(){function e(t){y()(this,e),this.element=t,this._container=this.element.closest(".comment"),this._children=this._container.querySelector(".comment__children"),this._id=this.element.dataset.id,this.api={get:this.element.dataset.apiGet,delete:this.element.dataset.apiDelete}}return g()(e,[{key:"getData",value:function(){var e=this;return new Promise((function(t,n){e.api.get||n("No get method"),Object(a.a)(e.api.get,{method:"GET"}).then((function(e){t(e)})).catch((function(e){n(e)}))}))}},{key:"delete",value:function(){var e=this;return new Promise((function(t,n){e.api.delete||n("No delete method"),Object(a.a)(e.api.delete,{method:"POST"}).then((function(n){var o=!!n.html&&n.html.trim();o?e.updateComment(o):e._remove(),t(n)})).catch((function(e){n(e)}))}))}},{key:"updateComment",value:function(e){this.element.insertAdjacentHTML("beforeBegin",e),this.element.remove(),this.element=null}},{key:"_remove",value:function(){this._container.remove(),this.element=null,this.container=null}},{key:"id",get:function(){return this._id}},{key:"children",get:function(){return this._children}}]),e}(),S=function(e){var t=e.closest(".comment-entity");return!!t&&new k(t)},C=n(14),E=n(5),A=function(e,t){var n=e.querySelector("[data-add-files]"),o=e.querySelector("[data-previews]"),r=e.querySelector("[data-preview-tmp]");n&&n.addEventListener("click",(function(){e.querySelectorAll('[name="'.concat(t,'"]')).length>=2&&(E.a.open("Не больше 2 изображений",{state:"error"}),1)||C.c({multiple:!1,accept:C.a.image}).then((function(n){var i=n.files,a=n.input;a.name=t,e.appendChild(a),C.b(i[0]).then((function(e){var t=function(e,t,n){var o=e.cloneNode(!0);return o.querySelector("img").src=t,o.querySelector("[data-close]").addEventListener("click",(function(e){n()})),o}(r,e,(function(){a.remove(),t.remove()}));o.appendChild(t)}))}))}))},q=void 0,L=function(e,t){t.insertAdjacentHTML("afterBegin",e),t.firstElementChild.scrollIntoView({behavior:"smooth",block:"center"})},O=(r=Array.from(document.querySelectorAll("[data-comments]")),function(e){r.forEach((function(t){t.textContent=e;var n=t.closest("[data-ending]");n&&n.setAttribute("data-ending",Object(c.a)(e,c.a.KEYS))}))}),j=function(e){e.element.style.display=""},P=function(){var e,t=document.querySelector(".comments-feed");t&&v(t);var n=document.getElementById("create-comment-form");n&&(A(n,"commentFiles[]"),new _(n,{onCommentCreate:function(e){e.count&&O(e.count),L(e.html,t),this.clear(),document.body.dispatchEvent(new Event("feed.events.update"))}}));var o=document.getElementById("comments-form");o&&(A(o,"commentFiles[]"),i=new _(o,{onCommentCreate:function(e){e.count&&O(e.count);var t=this.entity;t&&("edit"==i.state?t.updateComment(e.html):L(e.html,t.children),t=null,this.entity=null,document.body.dispatchEvent(new Event("feed.events.update"))),this.close(),this.clear()},onCancelEdit:function(){q.close(),q.clear(),q.entity&&j(q.entity)}})),document.addEventListener("click",(function(t){if(!e){t.target.hasAttribute("data-comment-reply")&&function(e){var t=S(e);if(t){var n="";if(i.entity){if("answer"==i.state&&i.entity==t)return;"edit"==i.state?j(i.entity):"answer"==i.state&&(n=i.text)}i.clear(),i.entity=t,i.state="answer",i.text=n,t.element.appendChild(i.form),i.focus()}}(t.target);var n,o=t.target.closest("[data-comment-delete]");if(o){if(o.blocked)return;o.blocked=!0,o.setAttribute("data-loading",""),e=!0,(n=o,new Promise((function(e,t){var o=S(n);o&&window.confirm({question:"Это действие безвозвратно удалит ваш комментарий",confirmButton:"Удалить"}).then((function(){o.delete().then((function(t){O(t.count),e()})).catch((function(t){console.error(t),e()}))})).catch((function(e){return t(e)}))}))).then((function(){o.removeAttribute("data-loading"),o.blocked=!1,e=!1})).catch((function(){o.removeAttribute("data-loading"),o.blocked=!1,e=!1}))}var r=t.target.closest("[data-comment-edit]");if(r){if(r.blocked)return;r.blocked=!0,r.setAttribute("data-loading",""),e=!0,function(e){return new Promise((function(t){var n=S(e);if(n){if(i.entity){if("edit"==i.state){if(i.entity==n)return void t();j(i.entity)}i.clear()}i.entity=n,i.state="edit",n.getData().then((function(e){i.setData(e),Object(s.a)(document.body,"remove.modal"),n.element.parentElement.insertBefore(i.form,n.element),i.focus(),n.element.style.display="none",t()})).catch((function(e){console.error(e),t()}))}}))}(r).then((function(){r.removeAttribute("data-loading"),r.blocked=!1,e=!1}))}var a=t.target.closest("[data-to-parent]");if(a){var c=document.querySelector('[data-id="'.concat(a.dataset.toParent,'"]'));c&&(c.classList.remove("highlight"),setTimeout((function(){c.classList.add("highlight")}),0))}}}))};onDomReady.then((function(){return P()}))},4:function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var o=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=Object.assign({bubbles:!0,cancelable:!0},n),r=new Event(t,o);e.dispatchEvent(r)}},5:function(e,t,n){"use strict";var o=n(2),r=n.n(o),i=n(0),a=n.n(i),c=null,u=null,s=function(){(c=document.createElement("div")).classList.add("toast"),(u=document.createElement("div")).classList.add("toast__text"),c.appendChild(u),c.addEventListener("click",(function(){d.close()}))},l=null,d=function(){function e(){r()(this,e)}return a()(e,null,[{key:"close",value:function(){clearTimeout(l),c.remove(),c.classList.remove("shown")}},{key:"open",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};c||s(),u.innerHTML=t,c.setAttribute("data-placement",n.place||"top-right"),c.setAttribute("data-state",n.state||"default"),document.body.appendChild(c),c.classList.add("shown"),"infinity"!==n.delay&&(l=setTimeout((function(){e.close()}),n.delay||5e3))}}]),e}();t.a=d}});
//# sourceMappingURL=comments.service.min.js.map