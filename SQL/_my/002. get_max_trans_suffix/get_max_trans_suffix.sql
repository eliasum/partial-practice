/*2025.04.10 17:26 IMM*/
-- Скрипт: get_max_trans_suffix.sql
-- Назначение:
--   Найти максимальное значение "хвоста" (последние 6 цифр) из столбца trans_einh таблицы u_tpe_info.
--   Исключаются строки, содержащие символ '$', а также пустые или слишком короткие значения.
--   Результат возвращается в виде строки длиной 6 символов с ведущими нулями.

SELECT 
    -- Формируем строку с ведущими нулями:
    -- 1. MAX(...) — находим максимальное значение среди подходящих строк;
    -- 2. CAST(... AS VARCHAR(6)) — преобразуем его в строку;
    -- 3. RIGHT('000000' + ..., 6) — добавляем слева нули и обрезаем справа до 6 символов.
    RIGHT(
        '000000' + CAST(
            MAX(
                -- Извлекаем "хвост" строки trans_einh, начиная с 5-го символа,
                -- и преобразуем его в целое число для корректного поиска максимума.
                CAST(SUBSTRING(trans_einh, 5, LEN(trans_einh) - 4) AS INT)
            ) AS VARCHAR(6)
        ), 
        6
    ) AS MaxValue
FROM 
    u_tpe_info
WHERE 
    -- Исключаем строки, содержащие символ доллара ($),
    -- такие строки считаются неподходящими по формату.
    trans_einh NOT LIKE '%$%'

    -- Исключаем строки, в которых значение NULL — 
    -- так как невозможно обработать "ничего"
    AND trans_einh IS NOT NULL

    -- Убираем слишком короткие строки, у которых длина < 5 символов,
    -- чтобы избежать ошибки при попытке извлечь подстроку с 5-го символа.
    AND LEN(trans_einh) >= 5;
